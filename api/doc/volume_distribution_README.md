# 成交量分布分析功能

## 功能概述

成交量分布分析是一个专业的市场微观结构分析工具，用于分析某个交易日所有股票的成交量分布情况，提供多维度的集中度指标，帮助投资者：

- 📊 **了解市场资金流向**：识别资金集中在哪些股票
- 🎯 **评估市场健康度**：判断市场是否过度集中或分散
- 📈 **辅助择时决策**：通过集中度变化判断市场阶段
- 🔍 **发现投资机会**：识别板块轮动和热点切换

## 核心指标

### 1. Top N 成交量占比

展示头部股票的成交量占比，快速了解资金集中程度：

- **Top 10**: 前10只股票的成交量占比
- **Top 30**: 前30只股票的成交量占比
- **Top 50**: 前50只股票的成交量占比
- **Top 100**: 前100只股票的成交量占比

### 2. 集中度指标

#### HHI (赫芬达尔-赫希曼指数)
- **范围**: 0-10000
- **含义**: 衡量市场集中程度
- **判断**: < 1500 低集中度，1500-2500 中等，> 2500 高集中度

#### Gini Coefficient (基尼系数)
- **范围**: 0-1
- **含义**: 衡量分布不均衡程度
- **判断**: < 0.3 相对均匀，0.3-0.5 中等不均，> 0.5 高度不均

#### CR4/CR8 (集中度比率)
- **含义**: 前4名/前8名股票的成交量占比
- **判断**: CR4 > 50% 高度集中，30-50% 中度集中，< 30% 较为分散

#### Entropy (熵指数)
- **含义**: 衡量分布的混乱程度
- **特点**: 值越小越集中，值越大越分散

## 使用场景

### 场景 1: 市场阶段判断

```
牛市特征：
- HHI < 1500 (低集中度)
- Gini 0.3-0.5 (中等不均)
- Top100 占比高 (普涨格局)

熊市特征：
- HHI > 2500 (高集中度)
- Gini > 0.5 (高度不均)
- Top10 占比显著高于 Top100
```

### 场景 2: 风险评估

```
高风险信号：
- HHI > 2500
- Gini > 0.6
- CR4 > 50%
→ 可能预示流动性风险

健康市场：
- HHI < 1500
- Gini < 0.4
- CR4 < 30%
→ 市场参与度高，流动性好
```

### 场景 3: 择时参考

```
买入信号：
- 成交量从集中转向分散
- HHI 下降，Gini 下降
- Top100 占比上升
→ 市场情绪转暖

卖出信号：
- 成交量从分散转向集中
- HHI 上升，Gini 上升
- Top10 占比快速上升
→ 市场情绪转冷
```

### 场景 4: 板块轮动

```
通过对比不同交易日的数据：
- CR4/CR8 变化 → 龙头股影响力变化
- Top N 占比变化 → 资金流向变化
- 熵指数变化 → 市场多样性变化
```

## 快速开始

### 1. 启动服务

```bash
cd api
cargo run --package web_api
```

### 2. 调用 API

```bash
# 查询某个交易日的成交量分布
curl "http://localhost:8000/api/volume-distribution?trade_date=20240101"

# 指定返回 Top 100 股票详情
curl "http://localhost:8000/api/volume-distribution?trade_date=20240101&top_n=100"
```

### 3. 运行测试脚本

```bash
# Linux/Mac
bash doc/volume_distribution_example.sh

# Windows PowerShell
.\doc\volume_distribution_example.ps1
```

## 文档

- **API 文档**: [volume_distribution_api.md](./volume_distribution_api.md)
- **测试脚本**: 
  - Bash: [volume_distribution_example.sh](./volume_distribution_example.sh)
  - PowerShell: [volume_distribution_example.ps1](./volume_distribution_example.ps1)

## 技术架构

### 后端实现

```
api/
├── service/src/stock/
│   └── volume_distribution_service.rs  # 业务逻辑层
└── web_api/src/controller/
    └── volume_distribution_controller.rs  # API 控制器
```

### 核心算法

1. **HHI 计算**: Σ(市场份额²) × 10000
2. **Gini 计算**: 基于洛伦兹曲线的不均衡指数
3. **CR 计算**: 前 N 名市场份额之和
4. **Entropy 计算**: -Σ(份额 × ln(份额))

### 性能优化

- ✅ 数据库查询优化（按成交量降序）
- ✅ 向量化计算
- ✅ 支持缓存机制
- ✅ 异步处理

## 数据说明

### 数据来源
- **表名**: `stock_daily`
- **字段**: `vol` (成交量), `amount` (成交额), `pct_chg` (涨跌幅)
- **更新频率**: 每日收盘后更新

### 数据质量
- ✅ 自动过滤成交量为 0 的股票
- ✅ 按成交量降序排列
- ✅ 支持日期格式验证

## 实战案例

### 案例 1: 识别结构性行情

```
2024-01-15 数据：
- Top10: 35%
- Top100: 62%
- HHI: 1200
- Gini: 0.58

分析：Top10 占比高但 Top100 占比不高，说明资金集中在少数龙头股，
     属于结构性行情，应关注龙头股机会。
```

### 案例 2: 判断市场过热

```
2024-03-20 数据：
- HHI: 3500 (高集中度)
- Gini: 0.72 (高度不均)
- CR4: 58%

分析：多个指标显示市场高度集中，可能存在流动性风险，
     建议谨慎操作或降低仓位。
```

### 案例 3: 发现普涨行情

```
2024-05-10 数据：
- Top10: 18%
- Top100: 78%
- HHI: 800
- Gini: 0.35

分析：成交量分散到更多股票，市场参与度高，
     属于普涨格局，可以适当提高仓位。
```

## 注意事项

1. **数据时效性**: 确保使用最新的交易日数据
2. **综合判断**: 不要单独依赖某一个指标，应综合分析
3. **趋势观察**: 关注指标的变化趋势，而不是单日数值
4. **结合其他指标**: 配合技术指标、市场情绪等综合判断
5. **行业差异**: 不同行业的集中度特征可能不同

## 未来规划

- [ ] 支持按行业/板块分析
- [ ] 添加历史趋势对比
- [ ] 提供可视化图表
- [ ] 支持自定义时间范围分析
- [ ] 添加预警功能
- [ ] 支持导出报告

## 贡献

欢迎提交 Issue 和 Pull Request！

## 许可证

MIT License

## 联系方式

如有问题或建议，请提交 Issue。
